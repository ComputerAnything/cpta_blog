name: Health Check Monitoring

on:
  # Run once daily at 10 AM UTC (lightweight daily check)
  schedule:
    - cron: '0 10 * * *'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  health-check:
    name: Check Production Health
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Run health checks
        id: health
        continue-on-error: true
        run: |
          ssh -i ~/.ssh/id_ed25519 cheloniixd@${{ secrets.SERVER_IP }} << 'EOF'
            cd /opt/blog_app

            # Run monitoring script
            bash deployment/monitoring.sh

            # Capture exit code
            EXIT_CODE=$?

            if [ $EXIT_CODE -eq 0 ]; then
              echo "STATUS=healthy" >> $GITHUB_OUTPUT
            else
              echo "STATUS=unhealthy" >> $GITHUB_OUTPUT
            fi

            exit $EXIT_CODE
          EOF

      - name: Notify if unhealthy
        if: steps.health.outcome == 'failure'
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "content": "@everyone",
                 "embeds": [{
                   "title": "ðŸš¨ Blog Health Check Failed",
                   "description": "One or more services are not responding",
                   "color": 15158332,
                   "fields": [
                     {"name": "Time", "value": "'"$(date -u)"'", "inline": true},
                     {"name": "Server", "value": "${{ secrets.SERVER_IP }}", "inline": true},
                     {"name": "âš ï¸ Immediate Action Required", "value": "1. Check Docker containers: `docker compose -f docker-compose.prod.yml ps`\n2. Check logs: `docker logs blog_backend --tail 100`\n3. Verify services are running\n4. Check server resources: `htop`, `df -h`", "inline": false}
                   ],
                   "footer": {"text": "Blog - Health Monitor"}
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      # Only notify success on manual runs (not daily)
      - name: Notify if healthy (manual run only)
        if: github.event_name == 'workflow_dispatch' && steps.health.outcome == 'success'
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "embeds": [{
                   "title": "âœ… All Services Healthy",
                   "description": "Production health check passed",
                   "color": 5763719,
                   "fields": [
                     {"name": "Time", "value": "'"$(date -u)"'", "inline": true},
                     {"name": "Backend", "value": "âœ… Responding", "inline": true},
                     {"name": "Frontend", "value": "âœ… Accessible", "inline": true},
                     {"name": "Nginx", "value": "âœ… Running", "inline": true},
                     {"name": "Redis", "value": "âœ… Connected", "inline": true},
                     {"name": "Containers", "value": "âœ… All running", "inline": true}
                   ],
                   "footer": {"text": "Blog - Health Monitor"}
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Health check summary
        if: always()
        run: |
          if [ "${{ steps.health.outcome }}" == "success" ]; then
            echo "## âœ… Health Check Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All production services are healthy and responding." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Health Check Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more services are not responding correctly." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Troubleshooting steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. SSH to server: \`ssh cheloniixd@${{ secrets.SERVER_IP }}\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Check container status: \`docker compose -f docker-compose.prod.yml ps\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Check logs: \`docker logs blog_backend --tail 100\`" >> $GITHUB_STEP_SUMMARY
            echo "4. Restart if needed: \`docker compose -f docker-compose.prod.yml restart\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
