name: Manual Blog Backup

on:
  # Manual trigger only - rely on Neon's automatic backups for daily protection
  workflow_dispatch:
    inputs:
      upload_to_drive:
        description: 'â˜ï¸ Upload to Google Drive'
        required: false
        type: boolean
        default: true
      retention_days:
        description: 'How many days to keep this backup'
        required: false
        type: choice
        default: '30'
        options:
          - '7'
          - '30'
          - '90'
          - '365'
      reason:
        description: 'Reason for backup (e.g., "Before migration", "Monthly archive")'
        required: false
        type: string
        default: 'Manual backup'

jobs:
  backup:
    name: Backup Blog to Google Drive
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Run backup script
        run: |
          ssh -i ~/.ssh/id_ed25519 cheloniixd@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            cd /opt/blog_app

            echo "ðŸ—„ï¸ Starting blog backup..."
            bash deployment/backup.sh \
              ${{ inputs.upload_to_drive == true && '--upload' || '' }} \
              --retention ${{ inputs.retention_days }} \
              --reason "${{ inputs.reason }}"
          EOF

      - name: Verify backup
        run: |
          ssh -i ~/.ssh/id_ed25519 cheloniixd@${{ secrets.SERVER_IP }} << 'EOF'
            BACKUP_DIR="/opt/backups/blog_app"
            LATEST_BACKUP=$(ls -t "$BACKUP_DIR"/*.tar.gz 2>/dev/null | head -1)

            if [ -f "$LATEST_BACKUP" ]; then
              SIZE=$(du -h "$LATEST_BACKUP" | cut -f1)
              echo "âœ… Local backup verified: $LATEST_BACKUP"
              echo "ðŸ“¦ Size: $SIZE"

              # Test archive integrity
              if tar -tzf "$LATEST_BACKUP" > /dev/null 2>&1; then
                echo "âœ… Archive integrity verified"
              else
                echo "âŒ Archive may be corrupted!"
                exit 1
              fi

              # If uploading to cloud, verify that too
              if [ "${{ inputs.upload_to_drive }}" = "true" ]; then
                if command -v rclone &> /dev/null; then
                  BASENAME=$(basename "$LATEST_BACKUP")
                  if rclone lsf gdrive:blog_backups/ | grep -q "$BASENAME"; then
                    echo "âœ… Google Drive backup verified"
                  else
                    echo "âš ï¸ Backup not found in Google Drive"
                  fi
                fi
              fi
            else
              echo "âŒ No backup file found!"
              exit 1
            fi
          EOF

      - name: Backup summary
        run: |
          echo "## ðŸ—„ï¸ Manual Backup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason:** ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention:** ${{ inputs.retention_days }} days" >> $GITHUB_STEP_SUMMARY
          echo "- **Google Drive:** ${{ inputs.upload_to_drive == true && 'âœ… Uploaded' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What was backed up:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PostgreSQL database (all blog posts, users, comments)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Backup metadata (reason, date, retention)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.upload_to_drive }}" = "true" ]; then
            echo "- âœ… Uploaded to Google Drive (blog_backups/)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Storage locations:" >> $GITHUB_STEP_SUMMARY
          echo "- **Local:** /opt/backups/blog_app/*.tar.gz" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.upload_to_drive }}" = "true" ]; then
            echo "- **Cloud:** Google Drive (gdrive:blog_backups/)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Restoration:" >> $GITHUB_STEP_SUMMARY
          echo "To restore this backup:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Download from Google Drive (if uploaded)" >> $GITHUB_STEP_SUMMARY
          echo "rclone copy gdrive:blog_backups/YYYYMMDD_HHMMSS.tar.gz /opt/backups/blog_app/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Extract backup" >> $GITHUB_STEP_SUMMARY
          echo "cd /opt/backups/blog_app" >> $GITHUB_STEP_SUMMARY
          echo "tar -xzf YYYYMMDD_HHMMSS.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Restore database" >> $GITHUB_STEP_SUMMARY
          echo "gunzip -c YYYYMMDD_HHMMSS/database.sql.gz | psql <DATABASE_URL>" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Backup completed successfully!" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ Backup Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The manual backup has failed. Please investigate." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Possible issues:**" >> $GITHUB_STEP_SUMMARY
          echo "- Database connection failed" >> $GITHUB_STEP_SUMMARY
          echo "- Insufficient disk space on VPS" >> $GITHUB_STEP_SUMMARY
          echo "- pg_dump not installed on server" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.upload_to_drive }}" = "true" ]; then
            echo "- rclone not configured (run: rclone config)" >> $GITHUB_STEP_SUMMARY
            echo "- Google Drive authentication expired" >> $GITHUB_STEP_SUMMARY
          fi
