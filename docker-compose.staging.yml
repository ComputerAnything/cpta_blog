# Staging environment - localhost:8001 for testing before production
services:
  # Reverse proxy (internal only)
  nginx-proxy:
    image: nginx:alpine
    container_name: blog_nginx_staging
    restart: always
    ports:
      - "127.0.0.1:8001:80"  # Only accessible from localhost
    volumes:
      - ./deployment/nginx/staging-proxy.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - blog-frontend
    networks:
      - proxy_network

  # Redis for rate limiting
  redis:
    image: redis:7-alpine
    container_name: blog_redis_staging
    restart: always
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-changeme}
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
    networks:
      - backend_network
    expose:
      - "6379"

  # Backend API
  blog-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: blog_backend_staging
    env_file:
      - ./backend/.env.staging
    restart: always
    depends_on:
      - redis
    environment:
      - FLASK_ENV=staging
      - REDIS_URL=redis://:${REDIS_PASSWORD:-changeme}@redis:6379/0
    networks:
      - frontend_network
      - backend_network
    expose:
      - "8000"
    # Security hardening
    read_only: true
    tmpfs:
      - /tmp
      - /app/backend/__pycache__:uid=1000,gid=1000
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

  # Frontend (nginx serving React)
  blog-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: blog_frontend_staging
    restart: always
    depends_on:
      - blog-backend
    networks:
      - proxy_network
      - frontend_network
    expose:
      - "80"
    # Security hardening
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETUID
      - SETGID

networks:
  proxy_network:
    driver: bridge

  frontend_network:
    driver: bridge
    internal: false

  backend_network:
    driver: bridge
    internal: true
